<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Alerts</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Import the necessary Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Global variables for Firebase instances
        let db, auth, userId;
        let triggeredAlerts = new Set(); // To prevent duplicate alerts

        // DOM elements
        const userIdDisplay = document.getElementById('userIdDisplay');
        const alertForm = document.getElementById('alertForm');
        const alertInput = document.getElementById('alertInput');
        const alertsList = document.getElementById('alertsList');
        const messagesDiv = document.getElementById('messages');
        const currentPriceDisplay = document.getElementById('currentPriceDisplay');
        const messageBoxModal = document.getElementById('messageBoxModal');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxMessage = document.getElementById('messageBoxMessage');
        const messageBoxOkBtn = document.getElementById('messageBoxOkBtn');

        // Function to show a custom message box
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxMessage.textContent = message;
            messageBoxModal.classList.remove('hidden');
        }

        // Event listener for the message box OK button
        if (messageBoxOkBtn) {
            messageBoxOkBtn.addEventListener('click', () => {
                messageBoxModal.classList.add('hidden');
            });
        }

        // Function to fetch and update Bitcoin price
        async function fetchCryptoPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                const price = data.bitcoin.usd;
                currentPriceDisplay.textContent = `$${price.toLocaleString()}`;
                checkAlerts(price);
            } catch (error) {
                console.error("Error fetching crypto price:", error);
                currentPriceDisplay.textContent = "Error";
            }
        }
        
        // Function to check for alert triggers
        function checkAlerts(currentPrice) {
            const alerts = alertsList.querySelectorAll('li:not(.empty-message)');
            alerts.forEach(alertItem => {
                const alertId = alertItem.dataset.id;
                const targetPrice = parseFloat(alertItem.dataset.targetPrice);

                if (!isNaN(targetPrice) && !triggeredAlerts.has(alertId)) {
                    if (currentPrice >= targetPrice) {
                        showMessageBox('Alert Triggered!', `Bitcoin price has reached or exceeded $${targetPrice.toLocaleString()}! Current price is $${currentPrice.toLocaleString()}.`);
                        triggeredAlerts.add(alertId); // Add to the set to prevent repeat triggers
                    }
                }
            });
        }
        
        // Function to render alerts from Firestore
        function renderAlerts(alerts) {
            alertsList.innerHTML = ''; // Clear existing alerts
            if (alerts.length === 0) {
                alertsList.innerHTML = `<p class="empty-message">No alerts yet. Create one!</p>`;
            } else {
                alerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.classList.add('alert-item');
                    li.dataset.id = alert.id;
                    li.dataset.targetPrice = alert.targetPrice;
                    li.innerHTML = `
                        <div class="alert-text">Alert for: Bitcoin</div>
                        <div class="alert-meta">
                            Target Price: <span class="price-value">$${alert.targetPrice.toLocaleString()}</span>
                            <br>
                            <span class="created-at">Created at: ${new Date(alert.createdAt?.seconds * 1000).toLocaleString()}</span>
                        </div>
                    `;
                    alertsList.appendChild(li);
                });
            }
        }

        // Function to handle the form submission and add a new alert
        async function addAlert(e) {
            e.preventDefault();
            const targetPrice = parseFloat(alertInput.value);

            if (isNaN(targetPrice) || targetPrice <= 0) {
                messagesDiv.innerHTML = `<p class="error">Please enter a valid target price.</p>`;
                setTimeout(() => { messagesDiv.innerHTML = ''; }, 3000);
                return;
            }

            try {
                // Add a new document to the 'alerts' collection
                const alertsCollection = collection(db, `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/data`);
                await addDoc(alertsCollection, {
                    targetPrice: targetPrice,
                    createdAt: new Date(),
                });
                
                // Clear the input field after successful submission
                alertInput.value = '';
                messagesDiv.innerHTML = `<p class="success">Alert added successfully!</p>`;
                setTimeout(() => { messagesDiv.innerHTML = ''; }, 3000);
            } catch (e) {
                console.error("Error adding document: ", e);
                messagesDiv.innerHTML = `<p class="error">Failed to add alert. Please try again.</p>`;
            }
        }

        // Main initialization function
        async function initializeFirebase() {
            try {
                // Use provided global variables for Firebase config
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User signed in with UID:", user.uid);
                        userId = user.uid;
                        userIdDisplay.textContent = `Your User ID: ${userId}`;

                        const userAlertsQuery = query(collection(db, `/artifacts/${appId}/users/${userId}/data`));
                        onSnapshot(userAlertsQuery, (snapshot) => {
                            const userAlerts = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                            renderAlerts(userAlerts);
                        }, (error) => {
                            console.error("Error fetching alerts:", error);
                            showMessageBox('Data Fetch Error', 'Failed to load your alerts.');
                        });

                    } else {
                        console.log("No user signed in. Signing in anonymously...");
                        try {
                            await signInAnonymously(auth);
                            console.log("Anonymous sign-in successful.");
                        } catch (e) {
                            console.error("Anonymous sign-in failed:", e);
                            showMessageBox('Authentication Error', 'Could not sign in. Please try again.');
                        }
                    }
                });

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    signInWithCustomToken(auth, token).catch((e) => {
                        console.error("Custom token sign-in failed:", e);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }

                fetchCryptoPrice();
                setInterval(fetchCryptoPrice, 30000);
                
                alertForm.addEventListener('submit', addAlert);
            } catch (e) {
                console.error("Initialization failed:", e);
                showMessageBox('Initialization Error', 'Failed to initialize the app. Check console for details.');
            }
        }

        // Wait for the window to load before initializing everything
        window.onload = initializeFirebase;
    </script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --background-color: #f0f4f8;
            --card-background: #ffffff;
            --text-color: #333333;
            --light-text-color: #777777;
            --border-color: #e0e0e0;
            --success-color: #43a047;
            --error-color: #d32f2f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        p.subtitle {
            font-size: 1rem;
            color: var(--light-text-color);
            margin-bottom: 25px;
        }

        #userIdDisplay {
            font-size: 0.9rem;
            color: var(--light-text-color);
            margin-bottom: 20px;
            word-wrap: break-word;
        }
        
        #currentPriceDisplay {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="number"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #messages {
            height: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .success {
            color: var(--success-color);
        }

        .error {
            color: var(--error-color);
        }

        #alertsList {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .alert-item {
            background-color: var(--background-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        .alert-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .alert-meta {
            font-size: 0.8rem;
            color: var(--light-text-color);
        }
        
        .price-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .empty-message {
            color: var(--light-text-color);
            font-style: italic;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (max-width: 500px) {
            .container {
                padding: 20px;
            }
            form {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
        }
        
        /* Custom Message Box */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .modal-content h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #d32f2f;
        }
        
        .modal-content p {
            margin-bottom: 20px;
            color: var(--text-color);
        }
        
        .modal-content button {
            background-color: #2e7d32;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Dark mode compatibility */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }
            .container {
                background-color: #2e2e2e;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }
            h1 {
                color: #81c784;
            }
            input[type="number"] {
                background-color: #3a3a3a;
                color: #e0e0e0;
                border-color: #555;
            }
            .alert-item {
                background-color: #3a3a3a;
                border-color: #555;
            }
            .alert-meta {
                color: #a0a0a0;
            }
            .price-value {
                color: #81c784;
            }
            .empty-message {
                color: #a0a0a0;
            }
            .modal-content {
                background-color: #2e2e2e;
            }
            .modal-content p {
                color: #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bitcoin Alerts</h1>
        <p class="subtitle">Set a target price and get an alert when Bitcoin reaches it!</p>

        <div id="userIdDisplay"></div>
        <p>Current BTC Price: <span id="currentPriceDisplay">Loading...</span></p>
        
        <form id="alertForm">
            <input type="number" id="alertInput" placeholder="Enter target price..." required step="0.01">
            <button type="submit">Create Alert</button>
        </form>

        <div id="messages"></div>

        <ul id="alertsList">
            </ul>
    </div>
    
    <div id="messageBoxModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxMessage"></p>
            <button id="messageBoxOkBtn">OK</button>
        </div>
    </div>
</body>
</html>
